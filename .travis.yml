sudo: required
dist: trusty
language: cpp
os:
- linux
compiler:
  - clang
  - gcc
osx_image: xcode8.3
jdk:
  - oraclejdk7
cache:
  directories:
  - "$BUILD_DIR/aws"
addons:
   apt:
      packages: ['zlib1g-dev', 'libbz2-dev', 'libsnappy-dev', 'curl', 'libgflags-dev', 'mingw-w64']
env:
  - TEST_GROUP=platform_dependent # 16-18 minutes
  - TEST_GROUP=1 # 33-35 minutes
  - TEST_GROUP=2 # 30-32 minutes
  # Run java tests
  - JOB_NAME=java_test # 4-11 minutes
  # Build ROCKSDB_LITE
  - JOB_NAME=lite_build # 3-4 minutes
  # Build examples
  - JOB_NAME=examples # 5-7 minutes
  - JOB_NAME=cmake # 3-5 minutes
  - JOB_NAME=cmake-mingw # 3 minutes

matrix:
  exclude:
  - os: osx
    env: TEST_GROUP=1
  - os: osx
    env: TEST_GROUP=2
  - os : osx
    env: JOB_NAME=cmake-mingw
  - os : linux
    compiler: clang
  - os : osx
    compiler: gcc

# https://docs.travis-ci.com/user/caching/#ccache-cache
install:
  - if [ "${TRAVIS_OS_NAME}" == osx ]; then
      brew install ccache;
      PATH=$PATH:/usr/local/opt/ccache/libexec;
    fi

before_script:
  # Increase the maximum number of open file descriptors, since some tests use
  # more FDs than the default limit.
  - ulimit -n 8192

script:
  - ${CXX} --version
  - if [ "${TEST_GROUP}" == 'platform_dependent' ]; then ccache -C && OPT=-DTRAVIS V=1 ROCKSDBTESTS_END=db_block_cache_test make -j4 all_but_some_tests check_some; fi
  - if [ "${TEST_GROUP}" == '1' ]; then OPT=-DTRAVIS V=1 ROCKSDBTESTS_START=db_block_cache_test ROCKSDBTESTS_END=comparator_db_test make -j4 check_some; fi
  - if [ "${TEST_GROUP}" == '2' ]; then OPT=-DTRAVIS V=1 ROCKSDBTESTS_START=comparator_db_test make -j4 check_some; fi
  - if [ "${JOB_NAME}" == 'java_test' ]; then OPT=-DTRAVIS V=1 make clean jclean && make rocksdbjava jtest; fi
  - if [ "${JOB_NAME}" == 'lite_build' ]; then OPT="-DTRAVIS -DROCKSDB_LITE" V=1 make -j4 static_lib tools; fi
  - if [ "${JOB_NAME}" == 'examples' ]; then OPT=-DTRAVIS V=1 make -j4 static_lib; cd examples; make -j4; fi
  - if [ "${JOB_NAME}" == 'cmake' ]; then mkdir build && cd build && cmake .. && make -j4 rocksdb; fi
  - if [ "${JOB_NAME}" == 'cmake-mingw' ]; then mkdir build && cd build && cmake .. -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ -DCMAKE_SYSTEM_NAME=Windows && make -j4 rocksdb; fi
notifications:
  slack:
    rooms:
      secure: uq/N3oixvz9hwX1VeLAFsXb5P7DnMk7eZIhzoSgsVWP/pVL26YPRzLamKUwUOCTW8HStQ20FHIjwidNuj28OaOS1maOAgJzG2SEgaer/LkbhmEwpKD4ik4Wqd5CKIDAZRYiVWe3PS1UYPGn7Ys0X9zsyewnPTMN6adwZr3PxiJUKl0Ce5jq35P7n+IYnklsJMoczj7yH/nssu7B0lgRcZrDl29JCYe8OaJZVOoBnmBJB/x1p9tHVGZo247yrYd2OTeR1ISFPWDiq0rQyFgTqXiLoq0ZyLO/DRLozegc39ljwcjQ5eiKOaQkwbHMWDc968Y/TsAQcSccMT80juIIdw2bVN3zPthMHosw/v9YyWGVPztFDyHIh2UcxfV/T2fGZN2pSMQ1g7yYYqla2qTOGXBGkIa4c0QqxukQhwZ3wV2Wx2cFhK/oOT+xtVqoW4vy20f1bbbcUoLR0lLxZRk902g1jot72z1NwdGGsCtH6x097xHs+M2PfB2Dt4ICaAqsI+NR1s1hmfaQ4G8PuYSzuT2j3fIDRMbioeutfxMGJSYQ/R3w0ue7rjYecIDh3H+OGk5HSjD1nO1LV3UTWm5MPfsZcfwwGbSe2KMUtftghsSKRNg9WiUzApnZdrj5IdSoOw/A6Jgm29DEPJCtQDO8okU7oE+4lBuUh34PwMIQ+zfw=
    on_success: always
    on_failure: always
