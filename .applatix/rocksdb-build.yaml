---
type: service_template
subtype: container
name: rockdb-build-base
description: This is the base template for building rockdb component.
container:
  resources:
    mem_mib: 4000
    cpu_cores: 1.5
  image: get.applatix.io/rockdb-build:v1.1
  docker_options: "-e CC=%%build_env_cc%% -e CXX=%%build_env_gpp%% -e JOB_NAME=%%build_env_job_name%% -e USE_AWS=%%build_env_use_aws%% -e J=%%build_parallel%% -e TRAVIS_BUILD_DIR=%%build_env_travis_build_dir%% %%build_env_tests%%" 
  command: bash -c 'cd /src/build_tools && %%build_sec_env%% %%build_sec_env2%% ./ax_build.sh'
inputs:
  artifacts:
  - from: "%%checkout_artifact%%"
    path: "/src"
  parameters:
    checkout_artifact:
    build_env_cc:
    build_env_gpp:
    build_env_job_name:
    build_env_use_aws:
    build_parallel:
    build_env_travis_build_dir:
    build_env_tests:
    build_sec_env:
    build_sec_env2:
outputs:

---
type: service_template
subtype: workflow
name: rockdb-build-standalone
description: This is the workflow for building/testing all rockdb components.
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    build_env_cc:
      default: '/usr/bin/gcc'
    build_env_gpp:
      default: '/usr/bin/g++'
    build_env_job_name:
      default: 'unittests'
    build_env_use_aws:
      default: '1'
    build_parallel:
      default: '1'
    build_env_travis_build_dir:
      default: '/src'
    build_sec_env:
      default: '%%secrets.==$1$key=default$text$AP0JF/mIdE1c1ygnRpC70u2RNY+sQNbWC2x5x56imS7FMsI9nQvgnTnj5vVnq8aCI3Ldt4YvsOcVsVk0Qs9v6vsQzojvn6Gdv+IkwVZ9IDwQZXz8lxUklEFDR14K9gkae4RcOfigTy6ELgDocVKvRU8M8xZkGpFM1CzYGgw32ZoAG7zfZWvTNoIgRn9hawS9YjsjX1LvQoJbK6JoLdQCTGEGgofEC2XW92EiD+K7o0Oo99tZOVUtgaiZ0liztBHqQqKxPPnsYUP4RU0n7WB1RXkQVNoqyCua2bB5VkffxbLHcA84rj5xWAJrlt6JoMS/FivODJ5/n55vqW9ZXiuz0r688OWegn6jtvCcigxOodJxax4qEAfXkYe317XjSN2bhjA/usZysDmaS48KsWG0T8HC2g5dH4S1IyV69+MAiMvhaw====%%'
    build_sec_env2:
      default: '%%secrets.==$1$key=default$text$ATcbh4pK0xFvbnT9GpikmurIWpoQ84Xa/QzDawHg38mGaVOQ790hupceyfoIN16VAXYxgzB1YedSIDWCf6va9rfQEvkuKCKmYv/172RG6gCXVvoJ1sN7pjXa1SMjuvubODZ73zg82r/Y1rN092wLqnyrmtN5Ll7mojusRBMlh3ocbok8t4X38aTy6byDuEh9TSk2e1ClET5QADWTgJhX3Z5CfIUfDNQtFi8rJOqrZ0pVMp5rnmV6h4o1zNklnjNkvIYAdEbGMZfcpdv7aL68hwFaoDMwjVNTNaUTHYdHLbmI04rsr/CgHuOrIihatDLu81XSa7S9k3SZqqgvm8gGcQusc7SN3dvXObNG0HVssChqyVmAhr+y2nWOHzpMV9h3kzER4XfQegjJd/On8oXtDwzb7MgbaZyOL7iICZrJORCnKQ====%%'

steps:
  - checkout:
      template: axscm-checkout
  - rockdb-build:
      template: rockdb-build-base
      parameters:
        checkout_artifact: "%%steps.checkout.code%%"
        build_env_tests: $$[-e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appone -e ROCKSDBTESTS_START=db_cloud_test -e ROCKSDBTESTS_END=db_block_cache_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=apptwo -e ROCKSDBTESTS_START=db_block_cache_test -e ROCKSDBTESTS_END=db_dynamic_level_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appthr -e ROCKSDBTESTS_START=db_dynamic_level_test -e ROCKSDBTESTS_END=db_sst_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appfor -e ROCKSDBTESTS_START=db_sst_test -e ROCKSDBTESTS_END=db_universal_compaction_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appfiv -e ROCKSDBTESTS_START=db_universal_compaction_test -e ROCKSDBTESTS_END=comparator_db_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appsix -e ROCKSDBTESTS_START=comparator_db_test]$$

termination_policy:
  time_seconds: 7200
  spending_cents: 100

---
type: policy
name: Rocksdb Build Policy
description: Policy to trigger build for all events
template: rockdb-build-standalone
parameters:
notifications:
  -
    when:
      - on_success
      - on_failure
    whom:
      - committer
      - author
      - c1v6r2o8a5v7u6g4@rockset-io.slack.com
when:
  -
    event: on_push
    target_branches:
      - ".*"
  -
    event: on_pull_request
    target_branches:
      - ".*"
  -
    event: on_pull_request_merge
    target_branches:
      - ".*"

