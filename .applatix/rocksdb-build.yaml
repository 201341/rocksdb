---
type: service_template
subtype: container
name: rockdb-build-base
description: This is the base template for building rockdb component.
container:
  resources:
    mem_mib: 4000
    cpu_cores: 1.5
  image: get.applatix.io/rockdb-build:v1.1
  docker_options: "-e CC=%%build_env_cc%% -e CXX=%%build_env_gpp%% -e JOB_NAME=%%build_env_job_name%% -e USE_AWS=%%build_env_use_aws%% -e J=%%build_parallel%% -e TRAVIS_BUILD_DIR=%%build_env_travis_build_dir%% %%build_env_tests%%" 
#  command: bash -c 'cd /src/build_tools && %%build_sec_env%% %%build_sec_env2%% ./ax_build.sh'
  command: bash -c 'cd /src/build_tools && ./ax_build.sh'
inputs:
  artifacts:
  - from: "%%checkout_artifact%%"
    path: "/src"
  parameters:
    checkout_artifact:
    build_env_cc:
    build_env_gpp:
    build_env_job_name:
    build_env_use_aws:
    build_parallel:
    build_env_travis_build_dir:
    build_env_tests:
    build_sec_env:
    build_sec_env2:
outputs:

---
type: service_template
subtype: workflow
name: rockdb-build-standalone
description: This is the workflow for building/testing all rockdb components.
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    build_env_cc:
      default: '/usr/bin/gcc'
    build_env_gpp:
      default: '/usr/bin/g++'
    build_env_job_name:
      default: 'unittests'
    build_env_use_aws:
      default: '1'
    build_parallel:
      default: '1'
    build_env_travis_build_dir:
      default: '/src'
    build_sec_env:
      default: '%%secrets.==$1$key=default$text$BqmWKIVl6BMbPHIVSB7WCK7gHR5BdvuQBEgT++p5zAwS4v1IslTM7PhPOw4vKlUdmBif2n9Z8JIo0+Iat8wok3gzDFDP1/LGwaxuQTkFz5aJDmpJmmeCcKyHplUWmowq2T3V1LCEn0wbkU3TIiwXCJ2W1MKr8Lk1vbmg/QarB9w===%%'
    build_sec_env2:
      default: '%%secrets.==$1$key=default$text$YsiFPasvel5dK2kas8/gU1vawhvoSRuC7fwwGImoMDfY5iI/LXGGZ9RwzrNIbQpXaqGYyXeOmXrFP6YAvcL29tEkXu7Ayd+mM5fak/CdLx40EmBZY2j9oLl82c8rUz+Ln76fReHuetWzNJhSv0K/v5FQ1PJ5IKNE8b8G/TQBNEI===%%'

steps:
  - checkout:
      template: axscm-checkout
  - rockdb-build:
      template: rockdb-build-base
      parameters:
        checkout_artifact: "%%steps.checkout.code%%"
        build_env_tests: $$[-e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appone ROCKSDBTESTS_START=db_cloud_test -e ROCKSDBTESTS_END=db_block_cache_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=apptwo ROCKSDBTESTS_START=db_block_cache_test -e ROCKSDBTESTS_END=db_dynamic_level_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appthr ROCKSDBTESTS_START=db_dynamic_level_test -e ROCKSDBTESTS_END=db_sst_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appfor ROCKSDBTESTS_START=db_sst_test -e ROCKSDBTESTS_END=db_universal_compaction_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appfiv ROCKSDBTESTS_START=db_universal_compaction_test -e ROCKSDBTESTS_END=comparator_db_test, -e ROCKSDB_CLOUD_TEST_BUCKET_NAME=appsix ROCKSDBTESTS_START=comparator_db_test]$$

termination_policy:
  time_seconds: 7200
  spending_cents: 100

---
type: policy
name: Rocksdb Build Policy
description: Policy to trigger build for all events
template: rockdb-build-standalone
parameters:
notifications:
  -
    when:
      - on_success
      - on_failure
    whom:
      - committer
      - author
      - c1v6r2o8a5v7u6g4@rockset-io.slack.com
when:
  -
    event: on_push
    target_branches:
      - ".*"
  -
    event: on_pull_request
    target_branches:
      - ".*"
  -
    event: on_pull_request_merge
    target_branches:
      - ".*"

